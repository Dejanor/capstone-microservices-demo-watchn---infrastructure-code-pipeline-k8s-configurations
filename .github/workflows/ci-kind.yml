name: Kind CI

on:
  push:
    branches:
    - master

jobs:
  build:
    name: CI
    runs-on: ubuntu-latest
    steps:
    - name: Check out code
      uses: actions/checkout@v2
    - name: Build images
      env:
        REPO: watchn
      run: |
        TAG=${GITHUB_SHA} scripts/build-all.sh
    - uses: "finnp/create-file-action@master"
      env:
        FILE_NAME: "config.yaml"
        FILE_DATA: |
          kind: Cluster
          apiVersion: kind.x-k8s.io/v1alpha4
          nodes:
          - role: control-plane
            kubeadmConfigPatches:
            - |
              kind: InitConfiguration
              nodeRegistration:
                kubeletExtraArgs:
                  node-labels: "ingress-ready=true"
            extraPortMappings:
            - containerPort: 80
              hostPort: 80
              protocol: TCP
            - containerPort: 443
              hostPort: 443
              protocol: TCP
    - uses: engineerd/setup-kind@v0.5.0
      with:
        config: config.yaml
    - name: Setup helmfile
      uses: mamezou-tech/setup-helmfile@v0.7.0
    - name: Deploy
      env:
        UI_SERVICE_TYPE: NodePort
      run: |
        kubectl apply -f https://raw.githubusercontent.com/kubernetes/ingress-nginx/master/deploy/static/provider/kind/deploy.yaml

        kubectl wait --namespace ingress-nginx \
          --for=condition=ready pod \
          --selector=app.kubernetes.io/component=controller \
          --timeout=90s

        kind load docker-image watchn/watchn-assets:${GITHUB_SHA}
        kind load docker-image watchn/watchn-cart:${GITHUB_SHA}
        kind load docker-image watchn/watchn-catalog:${GITHUB_SHA}
        kind load docker-image watchn/watchn-checkout:${GITHUB_SHA}
        kind load docker-image watchn/watchn-orders:${GITHUB_SHA}
        kind load docker-image watchn/watchn-ui:${GITHUB_SHA}

        cd deploy/kubernetes && IMAGE_TAG=${GITHUB_SHA} helmfile apply --suppress-diff

        sleep 60

        kubectl get pod -A
        kubectl get svc -A
    